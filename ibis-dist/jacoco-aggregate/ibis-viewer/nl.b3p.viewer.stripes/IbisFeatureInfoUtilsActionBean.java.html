<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>IbisFeatureInfoUtilsActionBean.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">IBIS distributie</a> &gt; <a href="../index.html" class="el_bundle">ibis-viewer</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.viewer.stripes</a> &gt; <span class="el_source">IbisFeatureInfoUtilsActionBean.java</span></div><h1>IbisFeatureInfoUtilsActionBean.java</h1><pre class="source lang-java linenums">package nl.b3p.viewer.stripes;

import com.google.gson.JsonObject;
import net.sourceforge.stripes.action.*;
import net.sourceforge.stripes.controller.LifecycleStage;
import net.sourceforge.stripes.validation.DateTypeConverter;
import net.sourceforge.stripes.validation.Validate;
import nl.b3p.geotools.filter.visitor.RemoveDistanceUnit;
import nl.b3p.viewer.config.ClobElement;
import nl.b3p.viewer.config.app.Application;
import nl.b3p.viewer.config.app.ApplicationLayer;
import nl.b3p.viewer.config.app.ConfiguredAttribute;
import nl.b3p.viewer.config.security.Authorizations;
import nl.b3p.viewer.config.services.*;
import nl.b3p.viewer.ibis.util.DateUtils;
import nl.b3p.viewer.ibis.util.IbisConstants;
import nl.b3p.viewer.util.ChangeMatchCase;
import nl.b3p.viewer.util.FeatureToJson;
import nl.b3p.viewer.util.FlamingoCQL;
import nl.b3p.viewer.util.IbisFeatureToJson;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.geotools.data.DataUtilities;
import org.geotools.data.FeatureSource;
import org.geotools.data.Query;
import org.geotools.data.simple.SimpleFeatureCollection;
import org.geotools.factory.CommonFactoryFinder;
import org.geotools.feature.collection.AbstractFeatureVisitor;

import org.geotools.filter.text.cql2.CQLException;
import org.geotools.filter.text.ecql.ECQL;
import org.json.JSONException;
import org.json.JSONObject;
import org.opengis.feature.Feature;
import org.opengis.feature.simple.SimpleFeature;
import org.opengis.filter.Filter;
import org.opengis.filter.FilterFactory2;
import org.opengis.filter.sort.SortBy;
import org.opengis.filter.sort.SortOrder;
import org.stripesstuff.stripersist.Stripersist;

import java.io.IOException;
import java.io.StringReader;
import java.math.BigInteger;
import java.util.*;

@UrlBinding(&quot;/action/ibisfeatureinfoutil&quot;)
@StrictBinding
<span class="nc" id="L49">public class IbisFeatureInfoUtilsActionBean extends LocalizableApplicationActionBean implements IbisConstants {</span>
<span class="nc" id="L50">    private static final Log LOG = LogFactory.getLog(IbisEditFeatureActionBean.class);</span>

    private static final String FID = FeatureInfoActionBean.FID;

    @Validate
    private Application application;

    /**
     * the application layer to get the features from.
     */
    @Validate
    private ApplicationLayer appLayer;
    /**
     * feature id to get.
     */
    @Validate
    private String fid;

    /**
     * ibis id to get.
     */
    @Validate
    private String ibisId;

    private Layer layer;

    private ActionBeanContext context;

    private boolean unauthorized;

    @After(stages = LifecycleStage.BindingAndValidation)
    public void loadLayer() {
<span class="nc" id="L82">        this.layer = appLayer.getService().getSingleLayer(appLayer.getLayerName(), Stripersist.getEntityManager());</span>
<span class="nc" id="L83">    }</span>

    @Before(stages = LifecycleStage.EventHandling)
    public void checkAuthorization() {
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (appLayer == null</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                || !Authorizations.isLayerReadAuthorized(layer, context.getRequest(), Stripersist.getEntityManager())) {</span>
<span class="nc" id="L89">            unauthorized = true;</span>
        }
<span class="nc" id="L91">    }</span>

    /**
     * @return json object with min, max and current mutatiedatum
     * @throws JSONException
     */
    public Resolution minmaxDate() throws JSONException {
<span class="nc" id="L98">        JSONObject json = new JSONObject();</span>
<span class="nc" id="L99">        json.put(&quot;success&quot;, Boolean.FALSE);</span>
<span class="nc" id="L100">        String error = null;</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (appLayer == null) {</span>
<span class="nc" id="L103">            error = &quot;appLayer parameter ontbreekt&quot;;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        } else if (unauthorized) {</span>
<span class="nc" id="L105">            error = &quot;actie niet toegestaan&quot;;</span>
        } else {
<span class="nc" id="L107">            FeatureSource fs = null;</span>
            try {
<span class="nc" id="L109">                fs = this.layer.getFeatureType().openGeoToolsFeatureSource();</span>
<span class="nc" id="L110">                FilterFactory2 ff = CommonFactoryFinder.getFilterFactory2();</span>
<span class="nc" id="L111">                executeQuery(fs, ff, json);</span>
<span class="nc" id="L112">                json.put(&quot;success&quot;, Boolean.TRUE);</span>
<span class="nc" id="L113">            } catch (IOException ex) {</span>
<span class="nc" id="L114">                error = ex.getLocalizedMessage();</span>
<span class="nc" id="L115">                LOG.error(error, ex);</span>
<span class="nc" id="L116">            } catch (Exception ex) {</span>
<span class="nc" id="L117">                error = ex.getLocalizedMessage();</span>
<span class="nc" id="L118">                LOG.error(error, ex);</span>
            } finally {
<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (fs != null) {</span>
<span class="nc" id="L121">                    fs.getDataStore().dispose();</span>
                }
            }
        }
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (error != null) {</span>
<span class="nc" id="L126">            json.put(&quot;error&quot;, error);</span>
        }
<span class="nc" id="L128">        return new StreamingResolution(&quot;application/json&quot;, new StringReader(json.toString()));</span>
    }

    private void executeQuery(FeatureSource fs, FilterFactory2 ff, JSONObject json) throws IOException, CQLException {
        // werkt niet: Filter f = ff.equal(ff.property(ID_FIELDNAME), ff.literal(new BigInteger(ibisId)));
<span class="nc" id="L133">        Filter f = ECQL.toFilter(ID_FIELDNAME + &quot;=&quot; + ibisId, ff);</span>
<span class="nc" id="L134">        Query q = new Query(</span>
<span class="nc" id="L135">                fs.getName().toString(),</span>
                f,
                new String[]{ID_FIELDNAME, MUTATIEDATUM_FIELDNAME}
        );
<span class="nc" id="L139">        q.setSortBy(new SortBy[]{ff.sort(MUTATIEDATUM_FIELDNAME, SortOrder.ASCENDING)});</span>
<span class="nc" id="L140">        q.setHandle(&quot;date-query&quot;);</span>
<span class="nc" id="L141">        LOG.debug(q);</span>
<span class="nc" id="L142">        SimpleFeatureCollection sfc = (SimpleFeatureCollection) fs.getFeatures(q);</span>

<span class="nc" id="L144">        List&lt;Date&gt; dateList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L145">        final Date[] perceelDate = new Date[1];</span>
<span class="nc" id="L146">        sfc.accepts(new AbstractFeatureVisitor() {</span>
            private Date d;
            private String _fid;

            @Override
            public void visit(Feature feature) {
<span class="nc" id="L152">                d = (Date) ((SimpleFeature) feature).getAttribute(MUTATIEDATUM_FIELDNAME);</span>
<span class="nc" id="L153">                _fid = ((SimpleFeature) feature).getID();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                if (_fid.equalsIgnoreCase(getFid())) {</span>
<span class="nc" id="L155">                    perceelDate[0] = d;</span>
                }
<span class="nc" id="L157">                LOG.info(&quot;feature: &quot; + _fid + &quot;, &quot; + d);</span>
<span class="nc" id="L158">                dateList.add(d);</span>
<span class="nc" id="L159">            }</span>
        }, null);

<span class="nc" id="L162">        json.put(&quot;featdate&quot;, IbisFeatureToJson.dateFormat.format(perceelDate[0]));</span>
<span class="nc" id="L163">        json.put(&quot;mindate&quot;, IbisFeatureToJson.dateFormat.format(DateUtils.getBeforeDate(dateList, perceelDate[0])));</span>
<span class="nc" id="L164">        json.put(&quot;maxdate&quot;, IbisFeatureToJson.dateFormat.format(DateUtils.getAfterDate(dateList, perceelDate[0])));</span>

<span class="nc" id="L166">        LOG.debug(json);</span>
<span class="nc" id="L167">    }</span>

    //&lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;getters and setters&quot;&gt;
    @Override
    public Application getApplication() {
<span class="nc" id="L172">        return this.application;</span>
    }

    public void setApplication(Application application) {
<span class="nc" id="L176">        this.application = application;</span>
<span class="nc" id="L177">    }</span>

    /**
     * Called by the Stripes dispatcher to provide context to the ActionBean before invoking the
     * handler method.  Implementations should store a reference to the context for use during
     * event handling.
     *
     * @param context ActionBeanContext associated with the current request
     */
    @Override
    public void setContext(ActionBeanContext context) {
<span class="nc" id="L188">        this.context = context;</span>
<span class="nc" id="L189">    }</span>

    /**
     * Implementations must implement this method to return a reference to the context object
     * provided to the ActionBean during the call to setContext(ActionBeanContext).
     *
     * @return ActionBeanContext associated with the current request
     */
    @Override
    public ActionBeanContext getContext() {
<span class="nc" id="L199">        return this.context;</span>
    }

    public ApplicationLayer getAppLayer() {
<span class="nc" id="L203">        return appLayer;</span>
    }

    public void setAppLayer(ApplicationLayer appLayer) {
<span class="nc" id="L207">        this.appLayer = appLayer;</span>
<span class="nc" id="L208">    }</span>

    public String getFid() {
<span class="nc" id="L211">        return fid;</span>
    }

    public void setFid(String fid) {
<span class="nc" id="L215">        this.fid = fid;</span>
<span class="nc" id="L216">    }</span>

    public String getIbisId() {
<span class="nc" id="L219">        return ibisId;</span>
    }

    public void setIbisId(String ibisId) {
<span class="nc" id="L223">        this.ibisId = ibisId;</span>
<span class="nc" id="L224">    }</span>
//&lt;/editor-fold&gt;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>