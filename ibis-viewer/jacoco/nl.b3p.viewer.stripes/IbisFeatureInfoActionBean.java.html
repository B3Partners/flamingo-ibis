<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IbisFeatureInfoActionBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">IBIS viewer</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.viewer.stripes</a> &gt; <span class="el_source">IbisFeatureInfoActionBean.java</span></div><h1>IbisFeatureInfoActionBean.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2015 B3Partners B.V.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package nl.b3p.viewer.stripes;

import java.io.IOException;
import javax.persistence.EntityManager;
import javax.servlet.http.HttpServletRequest;
import net.sourceforge.stripes.action.StrictBinding;
import net.sourceforge.stripes.action.UrlBinding;
import net.sourceforge.stripes.validation.Validate;
import nl.b3p.viewer.config.app.Application;
import nl.b3p.viewer.config.app.ApplicationLayer;
import nl.b3p.viewer.config.security.Authorizations;
import nl.b3p.viewer.config.services.SimpleFeatureType;
import nl.b3p.viewer.ibis.util.IbisConstants;
import nl.b3p.viewer.util.FeatureToJson;
import nl.b3p.viewer.util.IbisFeatureToJson;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.geotools.data.FeatureSource;
import org.geotools.data.Query;
import org.json.JSONArray;
import org.json.JSONException;
import org.stripesstuff.stripersist.Stripersist;

/**
 * Override feature info for {@link IbisConstants#KAVEL_LAYER_NAME} and
 * {@link IbisConstants#TERREIN_LAYER_NAME} to make sure we only get to see the current
 * feature in the client.
 *
 * @author mprins
 */
@UrlBinding(&quot;/action/ibisfeatureinfo&quot;)
@StrictBinding
<span class="nc" id="L49">public class IbisFeatureInfoActionBean extends FeatureInfoActionBean implements IbisConstants {</span>

<span class="nc" id="L51">    private static final Log log = LogFactory.getLog(IbisFeatureInfoActionBean.class);</span>

    @Validate
    private boolean historisch;

    /**
     * execute the query, can be overridden in subclasses to modify behaviour
     * such as workflow. {@inheritDoc }
     */
    @Override
    protected JSONArray executeQuery(ApplicationLayer al, SimpleFeatureType ft, FeatureSource fs, Query q) throws Exception {

        JSONArray features;
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (this.getLayer().getName().equalsIgnoreCase(KAVEL_LAYER_NAME)</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                || this.getLayer().getName().equalsIgnoreCase(TERREIN_LAYER_NAME)) {</span>

<span class="nc" id="L67">            IbisFeatureToJson ftjson = new IbisFeatureToJson(</span>
<span class="nc" id="L68">                    this.isArrays(),</span>
<span class="nc" id="L69">                    this.isEdit(),</span>
<span class="nc" id="L70">                    this.isGraph(),</span>
<span class="nc" id="L71">                    this.getAttributesToInclude());</span>

<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (Authorizations.isAppLayerWriteAuthorized(this.getApplication(), al,</span>
<span class="nc" id="L74">                    this.getContext().getRequest(), Stripersist.getEntityManager())) {</span>
                // workflow/edit behaviour
<span class="nc bnc" id="L76" title="All 2 branches missed.">                if (this.historisch) {</span>
<span class="nc" id="L77">                    log.debug(&quot;Executing custom 'historisch' IBIS featureinfo for write-authorized user on layer &quot; + this.getLayer().getName());</span>
<span class="nc" id="L78">                    features = ftjson.getHistorischeJSONFeatures(al, this.getLayer().getFeatureType(), fs, q);</span>
                } else {
<span class="nc" id="L80">                    log.debug(&quot;Executing custom IBIS featureinfo for write-authorized user on layer &quot; + this.getLayer().getName());</span>
<span class="nc" id="L81">                    features = ftjson.getWorkflowJSONFeatures(al, this.getLayer().getFeatureType(), fs, q);</span>
                }
            } else {
<span class="nc" id="L84">                log.debug(&quot;Executing custom IBIS featureinfo for non-write-authorized user on layer &quot; + this.getLayer().getName());</span>
<span class="nc" id="L85">                features = ftjson.getDefinitiefJSONFeatures(al, this.getLayer().getFeatureType(), fs, q);</span>
            }

<span class="nc" id="L88">        } else /* not a special layer in this application */ {</span>
<span class="nc" id="L89">            log.debug(&quot;Executing default IBIS featureinfo for 'any' user on layer &quot; + this.getLayer().getName());</span>
            // default behaviour for any other layers
<span class="nc" id="L91">            FeatureToJson ftjson = new FeatureToJson(this.isArrays(), this.isEdit(), this.isGraph(), this.getAttributesToInclude());</span>
<span class="nc" id="L92">            features = ftjson.getJSONFeatures(al, this.getLayer().getFeatureType(), fs, q, null, null, Stripersist.getEntityManager(), this.getApplication(), this.getContext().getRequest());</span>
        }

<span class="nc" id="L95">        return features;</span>
    }

    public boolean isHistorisch() {
<span class="nc" id="L99">        return historisch;</span>
    }

    public void setHistorisch(boolean historisch) {
<span class="nc" id="L103">        this.historisch = historisch;</span>
<span class="nc" id="L104">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>